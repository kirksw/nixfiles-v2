---
description: Rules for handling secrets with SOPS
globs: ["secrets/**/*.yaml", ".sops.yaml"]
alwaysApply: false
---

# Secrets Handling Rules

## Critical Rules

1. **NEVER** commit plaintext secrets
2. **NEVER** log or print secret values
3. **ALWAYS** use SOPS for secret management

## SOPS Structure

Secrets are organized by category:

```
secrets/
├── git/       # Git credentials and signing keys
├── ssh/       # SSH private keys
└── k8s/       # Kubernetes configs
```

## Working with Secrets

```bash
# Edit existing secret (decrypts temporarily)
sops secrets/ssh/default.yaml

# Create new secret (will auto-encrypt)
sops secrets/new-category/secret.yaml

# Update keys after .sops.yaml change
sops updatekeys secrets/path/to/file.yaml
```

## Adding New Secret Categories

1. Add path regex to `.sops.yaml`
2. Create the secret file with `sops`
3. Reference in Nix modules via `sops.secrets`

## In Nix Modules

```nix
# Reference a secret
sops.secrets."secret-name" = {
  sopsFile = ../secrets/category/file.yaml;
};

# Use in config
config.services.something.passwordFile = 
  config.sops.secrets."secret-name".path;
```
