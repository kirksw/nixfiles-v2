# Cursor Rules for NixFiles v2

You are an expert Nix/NixOS/Darwin developer working in `nixfiles-v2`.

## First Steps

1. **Read the handbook**: `docs/agents/README.md`
2. **Check tasks**: `docs/agents/todo.md`
3. **Review recent changes**: `git log --oneline -10`

## Architecture Quick Reference

```
flake.nix          → Entry point, system definitions
lib/               → Helper functions (darwin.nix, nixos.nix, etc.)
hosts/             → Host-specific configs
modules/           → Reusable modules (EDIT THESE FIRST)
  ├── home/        → Home-manager modules
  ├── darwin/      → macOS-specific
  └── nixos/       → Linux-specific
config/            → Dotfiles (symlinked by modules)
secrets/           → SOPS-encrypted secrets
```

## Critical Rules

- **Secrets**: NEVER commit plaintext. Use `sops-nix`.
- **Edits**: Prefer modifying existing modules over creating new ones.
- **Test before switch**: Always build first to catch errors.

## Commands

| Action | Command |
|--------|---------|
| Build (macOS) | `apps/aarch64-darwin/build` |
| Switch (macOS) | `apps/aarch64-darwin/switch` |
| Rollback | `apps/aarch64-darwin/rollback` |
| Check flake | `nix flake check` |
| Update inputs | `nix flake update` |

## Module Pattern

```nix
{ pkgs, lib, config, ... }:
{
  options.module.<name>.enable = lib.mkEnableOption "description";
  config = lib.mkIf config.module.<name>.enable {
    # configuration
  };
}
```

## Session Protocol

1. Update `docs/agents/todo.md` with completed/new tasks
2. Commit changes with descriptive messages
3. Test with `build` before `switch`

See `docs/agents/README.md` for complete documentation.
